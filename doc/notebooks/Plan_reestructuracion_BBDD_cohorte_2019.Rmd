---
title: Plan de reestructuración de las bases de datos de la cohorte 2019 de Edad con Salud
output:
  html_notebook:
    toc: yes
    toc_float: yes
    toc_depth: 4
  word_document:
    toc: yes
    toc_depth: '4'
    df_print: kable
params:
  test: yes
---

```{r setup, include=FALSE}
if (!require(pacman)) install.packages("pacman")
library(pacman)

p_load(knitr, ecs.data, tidyverse, lubridate, haven, glue, rlang)

opts_chunk$set(echo = TRUE, results = 'asis')
```

```{r functions}
print_date <- stamp("1 de enero de 1999", orders = "dmy")
```

```{r constants, include=FALSE}
# Code configuration:

IS_TEST <- TRUE
# IS_TEST <- params$test


# File system objects:

## Migration file structure directories:

ONEDRIVE_DIR <- file.path("~/../OneDrive - UAM") |>
  normalizePath(winslash = '/', mustWork = TRUE)

BACKUP_DIR <- file.path(ONEDRIVE_DIR, "Migration_BACKUP")


## Current file structure:

DB_BASE_DIR     <- read_ecs_folder("DB")
C2019W1_DIR     <- file.path(DB_BASE_DIR, "Ola_3/Cohorte_2019")
COMPLETE_DB_DIR <- file.path(C2019W1_DIR, "Muestra completa")
PRECOVID_DB_DIR <- file.path(C2019W1_DIR, "Submuestra_1_preconfinamiento")

COMPLETE_DB_FILENAME <- "PES16028242_MN_Final20210602.dta"
PRECOVID_DB_FILENAME <-
  "Edad con Salud ola 3_cohorte 2019_base completa_Stata14.dta"

COMPLETE_DB_FILEPATH <- file.path(COMPLETE_DB_DIR, COMPLETE_DB_FILENAME)
PRECOVID_DB_FILEPATH <- file.path(PRECOVID_DB_DIR, PRECOVID_DB_FILENAME)


## Testing file structure:

OUTPUT_TEST_DIR <- file.path(ONEDRIVE_DIR, "Migration_TEST")

COMPLETE_DB_DIR_OUT <- if (IS_TEST) OUTPUT_TEST_DIR else COMPLETE_DB_DIR

COMPLETE_DB_FILE_OUT <- file.path(
  COMPLETE_DB_DIR_OUT,
  "PES16028242_MN_Final20210602.dta"
)


## Migration files:

MASTER_DB_FILENAME <- "rawdata_c2019w1"
MASTER_DB_FILEPATH <- file.path(COMPLETE_DB_DIR, MASTER_DB_FILENAME, ".dta")


# Date objects:

LOCKDOWN_DATE <- dmy("14-03-2020")
EXAMPLE_MIG_DATE <- dmy("15-11-2021")

ld_date_printed     <- print_date(LOCKDOWN_DATE)
ex_mig_date_printed <- print_date(EXAMPLE_MIG_DATE)


# Dataset objects (variables and values):

INVALID_CASE_ID <- "6900702"

INTERVIEW_DATE_VAR <- "q0006_date"
int_date_var_sym <- sym(INTERVIEW_DATE_VAR)
```

# Resumen

La situación actual de los datos de la cohorte 2019 (muestra de refresco)
implica la muestra completa de participantes, por un lado, y la llamada
"submuestra preconfinamiento" por otro,
para los datos de la Ola 1 o *línea base*.
Se propone un plan para reestructurar el almacenamiento,
dejando solamente la BDD de la muestra completa,
junto con la información necesaria para identificar los casos pertenecientes
a la submuestra preconfinamiento.
La base de datos de la submuestra preconfinamiento, por su parte,
queda almacenada como versión histórica para evitar interferencias con
la versión actual de la BDD completa.

Se contemplan la documentación de los cambios en las BDD y sus
rutas de almacenamiento, las nuevas variables,
y un plan de migración a la nueva estructura de datos.


# Descripción de la situación actual

Los datos de Edad con Salud hacen referencia a dos cohortes distintas,
la cohorte inicial, llamada "Cohorte 2011", y la cohorte o muestra de refresco,
llamada "Cohorte 2019".
El trabajo de campo de esta segunda cohorte comenzó en 2019.
El `r ld_date_printed`, la situación de excepción producida por la pandemia
por COVID-19 impuso restricciones a la movilidad y confinamiento
domiciliario en todo el territorio español.
A causa de ello el trabajo de campo tuvo que posponerse indefinidamente,
dando lugar a que los datos de la muestra  que conforma la Cohorte 2019
no se completasen.
Como resultado de esta situación, se creó una BDD parcial,
que se ha dado en llamar _submuestra preconfinamiento_.
Esta submuestra es la que se utilizó para contactar a los participantes
del llamado "Subestudio COVID", a los cuales se les hizo una entrevista
telefónica poco después de levantarse las restriccciones de confinamiento
estricto, e incluye los datos que se habían conformado hasta el momento y
fueron enviados por la empresa adjudicataria del trabajo de campo (IPSOS).

Meses después se reanudó el trabajo de campo, completándose las entrevistas y
recogida de datos de los participantes faltantes hasta completar
el tamaño muestral necesario.
Como resultado, se obtuvo una BDD
con el total de los casos que conforman la muestra de la Cohorte 2019.
Por otro lado, es importante también recalcar que, en esta muestra completa,
**hay casos de participantes que fueron entrevistados antes del 14 de marzo de 2020**
pero que NO se habían procesado y volcado en la BDD
de la submuestra preconfinamiento.
Estos casos **NO forman parte de la submuestra preconfinamiento**.

Por último, es necesario tener en cuenta que existe un caso
(identificador único `r INVALID_CASE_ID`)
que pertenecía a la submuestra preconfinamiento pero posteriormente
fue invalidado por IPSOS.
Por lo tanto,
**este caso NO formaría parte de la BDD de la muestra completa**.

Las BBDD correspondientes a estas dos muestras
actualmente se encuentran en las siguientes rutas del
almacenamiento en la nube de OneDrive (carpeta de bases de datos):

- Submuestra preconfinamiento:
  `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Submuestra_1_preconfinamiento/Edad con Salud ola 3_cohorte 2019_base completa_Stata13.dta`  
  y  
  `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Submuestra_1_preconfinamiento/Edad con Salud ola 3_cohorte 2019_base completa_Stata14.dta`

- Muestra completa:
  `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa/PES16028242_MN_Final20210602.dta`

(De la submuestra preconfinamiento existen dos vesiones, como se puede ver,
en dos formatos diferentes de Stata.)

El problema principal de esta estructura de datos es la redundancia de los
datos correspondientes a la submuestra preconfinamiento entre las
dos BBDD, dado que estos datos se encuentran también en la BDD
de la muestra completa casi al completo.
No obstante, la situación se complica por el hecho de existir un caso con datos
en la BDD de submuestra preconfinamiento pero no en la muestra total;
es necesario contemplar este hecho a la hora de hacer la reestructuración.


# Propuesta de modificación

El 03/11/2021 se aprueba
modificar esta estructura de archivos con el objeto de eliminar
la redundancia anteriormente mencionada.
No obstante, es importante considerar que *se debe priorizar* el
**NO generar confusión en el equipo investigador de cara a futuro**.

La complicación de que una de las BDD NO sea un subconjunto de la otra
(es decir, ambas BBDD contienen algún caso que NO debería estar en la otra)
dificulta la situación.
Para resolverla, se propone conservar un histórico de la BDD de la submuestra
preconfinamiento, con acceso restringido.


```{r load-dbs}
# Cargar ambas BDD:
complete_db <- read_dta(COMPLETE_DB_FILEPATH)
precovid_db <- read_dta(PRECOVID_DB_FILEPATH)
```


## Procesado de datos de la muestra completa

En primer lugar se necesita identificar los casos de la submuestra
preconfinamiento.
Para ello se necesita crear una nueva variable que indique, para cada caso,
si pertenece o no a la muestra completa
Es importante tener en cuenta que
**esta variable distingue los nuevos casos de la muestra completa de aquellos que se encontraban SÓLO en la BDD de la submuestra preconfinamiento**.

Se determina además la existencia de riesgo de errores al confundir la semántica
de esta variable, interpretándose que identifica a los participantes a los que
se entrevistó antes del confinamiento, independientemente de si formaron parte
o no de la BDD de la *submuestra preconfinamiento*.
Para minimiazar en la medida de lo posible este riesgo se propone crear otra
variable que identifique los participantes que fueron entrevistados antes del
confinamiento.

```{r new-vars}
new_vars <- tibble(
  var   = c("subsample_pre", "interview_pre"),
  label = c(
    "Belongs to COVID-19 Pre-lockdown subsample",
    "Interview respect to COVID-19 lockdown"
  ),
  type  = "dichotomous",
  code  = list(c(No = 0, Yes = 1), c(Before = 1, After = 0))
)

subsample_pre_var <- new_vars |> slice(1)
sub_pre_var_sym <- subsample_pre_var |> pull(var) |> sym()

interview_pre_var <- new_vars |> slice(2)
int_pre_var_sym <- interview_pre_var |> pull(var) |> sym()
```


Las nuevas variables a crear por tanto son:

```{r new-vars-table}
new_vars |> write_vars_table()
```


Se utilizan los identificadores únicos de la BDD de la submuestra
preconfinamiento para distinguir los casos
que pertenecen o no a dicha submuestra y crear la variable
``r as_name(sub_pre_var_sym)``.
A continuación, se crea la variable ``r as_name(int_pre_var_sym)``,
comparando la fecha de cada entrevista (variable ``r INTERVIEW_DATE_VAR``).

```{r create-subsample-var}
precovid_db <- precovid_db |> mutate(
  !!sub_pre_var_sym := 1 |> labelled(
    labels = subsample_pre_var |> pull(code) |> unlist(),
    label  = subsample_pre_var |> pull(label)
  )
)

precovid_db_cases <- precovid_db |> select(ID_ECS, !!sub_pre_var_sym)

complete_db <- complete_db |>
  left_join(precovid_db_cases, by = "ID_ECS") |>
  mutate(!!sub_pre_var_sym := (!!sub_pre_var_sym) |> replace_na(0))
```

```{r create-interview-date-var}
complete_db <- complete_db |> mutate(
  !!int_pre_var_sym := (ymd(!!int_date_var_sym) <= LOCKDOWN_DATE) |>
    as.double() |>
    labelled(
      labels = interview_pre_var |> pull(code) |> unlist(),
      label  = interview_pre_var |> pull(label)
    )
)
```


Tras aplicador estos cambios,
el número de casos y el rango de fechas de entrevista
por cada combinación de las nuevas variables es:

```{r descriptives-new-vars, message=FALSE}
complete_db <- complete_db |>
  as_factor() |>
  mutate(across(all_of(new_vars |> pull(var)), fct_rev)) |>
  group_by(!!!syms(new_vars |> pull(var)))

new_vars_freq <- complete_db |> count()
new_vars_date <- complete_db |>
  summarize(value = range(q0006_date)) |>
  mutate(date = c("init", "end")) |>
  spread(date, value) |>
  select(init, end, everything())

new_vars_freq |> full_join(new_vars_date, by = new_vars |> pull(var))
```

Los cambios se guardan en el archivo de BDD de la muestra completa,

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa/PES16028242_MN_Final20210602.dta`,

**en formato Stata 13**.


## Cambios en rutas

La subcarpeta con los datos de muestra completa

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa`

junto con todos sus archivos y subcarpetas pasa a ser

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019`


La subcarpeta con los datos de submuestra preconfinamiento

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Submuestra_1_preconfinamiento`

junto con todos sus archivos y subcarpetas pasa a ser

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/history`


## Archivos afectados

Se borra el archivo de BDD de la submuestra preconfinamiento en version Stata 14:

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Submuestra_1_preconfinamiento/Edad con Salud ola 3_cohorte 2019_base completa_Stata14.dta`

(El motivo de este borrado es evitar la duplicidad de datos en varios formatos.)

El archivo de la submuestra preconfinamiento en version Stata 13

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Submuestra_1_preconfinamiento/Edad con Salud ola 3_cohorte 2019_base completa_Stata13.dta`

pasa a ser

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/history/snapshot_[MIGRATION_DATE].dta`

donde `[MIGRATION_DATE]` es la fecha de migración en formato YYYY-mm-dd;
por ejemplo, si la migración se lleva a cabo el `r ex_mig_date_printed`,
la ruta será

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/history/snapshot_`r EXAMPLE_MIG_DATE`.dta`


El archivo de la BDD de muestra completa

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa/PES16028242_MN_Final20210602.dta`

pasa a ser

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/rawdata_c2019w1.dta`


## Dependencias

### Carpetas y archivos de datasets de variables outcome

La ruta

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Submuestra_1_preconfinamiento/Outcome datasets`

pasa a ser

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome datasets/history`

Todos los archivos contenidos en esa carpeta se mueven a la nueva ruta.

La ruta

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Muestra completa/Outcome datasets`

y todas las subcarpetas y documentos contenidos en ella pasan a estar en

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome datasets`

Los archivos con los datasets de las variables outcome de muestra completa
se deben actualizar para incluir las dos nuevas variables.


### Carpetas y archivos de documentación de variables outcome

La ruta

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Submuestra_1_preconfinamiento/Outcome descriptions`

pasa a ser

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome descriptions/history`

Todos los archivos contenidos en esa carpeta se mueven a la nueva ruta.


La ruta

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Muestra completa/Outcome descriptions`

y todas las subcarpetas y documentos contenidos en ella pasan a estar en

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome descriptions`


### Documentos Rmd para la generación de variables outcome

Todos los documentos Rmarkdown para la generación de outcomes de Cohorte 2019
Ola 1, muestra completa, necesitan modificar la ruta de lectura del archivo de
BDD raíz en el chunk `load-data`; hay que cambiar

`use "~/UAM/marta.miret@uam.es - Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa/PES16028242_MN_Final20210602.dta"`

por

`use "~/UAM/marta.miret@uam.es - Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/rawdata_c2019w1.dta"`

En el chunk `save-data` hay que cambiar el comando `keep` para incluir
las nuevas variables:

`keep ID_ECS q0007a_result proxy ``r new_vars |> pull(var) |> glue_collapse(sep = ' ')`` <variables generadas>`

En este mismo chunk, hay que cambiar el comando `save` para utilizar la nueva
ruta de almacenamiento de los datasets de las variables outcome:

`save "~/UAM/marta.miret@uam.es - Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome datasets/<nombre_archivo>.dta", replace`


### Plantilla Rmd para la generación de variables outcome

En la plantilla del paquete `ecs.data` la línea 143

`* use "~/UAM/marta.miret@uam.es - Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa/PES16028242_MN_Final20210602.dta"`

se cambia por

`* use "~/UAM/marta.miret@uam.es - Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/rawdata_c2019w1.dta"`

Las líneas 144 y 145 se borran.

La línea 199

`keep ID_ECS q0007a_result proxy <variable(s) generada(s)>`

se sustituye por

`keep ID_ECS q0007a_result proxy `r new_vars |> pull(var) |> glue_collapse(sep = ' ')` <variable(s) generada(s)>`

La línea 216

`* save "~/UAM/marta.miret@uam.es - Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Submuestra_1_preconfinamiento/Outcome datasets/Outcome_<variable>_<qualifier>.dta", replace`

se borra, y la línea 217

`* save "~/UAM/marta.miret@uam.es - Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Muestra completa/Outcome datasets/Outcome_<variable>_<qualifier>.dta", replace`

se sustituye por

`* save "~/UAM/marta.miret@uam.es - Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome datasets/Outcome_<variable>_<qualifier>.dta", replace`


## Cambios en credenciales de OneDrive

Se revoca completamente el acceso (tanto de lectura como de escritura)
para todos los perfiles a las siguientes subcarpetas en OneDrive:

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/history`

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome datasets/history`

- `Documentacion Edad con Salud/Edad con salud - Ola 3/Outcomes/Cohorte 2019/Outcome descriptions/history`

Solamente se concede acceso
(se dejan las credenciales por defecto heredados de las carpetas raíz)
a los siguientes perfiles:

- Propietarios de las carpetas (marta.miret@uam.es y elvira.lara@uam.es)

- Responsables de mantenimiento de datos designados


# Documentación de los cambios

Este documento especifica todos los cambios realizados.
La versión final se debe integrar en la
[guía de investigadores de Edad con Salud](https://dauam.sharepoint.com/sites/EdadconSalud)
para dejar todas estas modificaciones documentadas.


# Plan de migración

## Copia de seguridad

Se copian en primer lugar las estructuras de archivos completas que se van a
modificar, con objeto de tener una copia de seguridad en caso de que
sea necesario revertir los cambios.

```{r create-backup}

```


## Actualización de la BDD de muestra completa

Los cambios en la BDD de muestra completa se guardan
en el archivo correspondiente, **en formato Stata 13**:

- `Bases de datos maestras Edad con Salud/Ola_3/Cohorte_2019/Muestra completa/PES16028242_MN_Final20210602.dta`,


```{r}
complete_db |> write_dta(path = COMPLETE_DB_FILE_OUT, version = 13)
```


## 
A concretar tras decidir la propuesta a implementar
